stages:
  - Dependencies
  - Build Javascript
  - Build Container

Fetch Dependencies:
  stage: Dependencies
  image: node:15.8.0-buster
  tags:
    - k8s:shared
  script:
    - yarn install
  cache:
    key: ${CI_COMMIT_SHA}
    paths:
      - ./node_modules
    policy: push

Build:
  stage: Build Javascript
  image: node:15.8.0-buster
  tags:
    - k8s:shared
  script:
    - npm build
  cache:
    key: ${CI_COMMIT_SHA}
    paths:
      - ./build
      - ./node_modules
    policy: pull-push

Kaniko:
  stage: Build Container
  image:
    name: gcr.io/kaniko-project/executor:debug
    entrypoint: [ "" ]
  tags:
    - k8s:shared
  script:
    - /kaniko/executor --context $CI_PROJECT_DIR --dockerfile $CI_PROJECT_DIR/Dockerfile --no-push
  cache:
    key: ${CI_COMMIT_SHA}
    paths:
      - ./build
    policy: pull

